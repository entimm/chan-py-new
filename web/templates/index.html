<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="description" content="KLineChart example"/>
    <title>缠论</title>
    <script type="text/javascript" src="/static/klinecharts.min.js"></script>
    <script type="text/javascript" src="/static/klinecharts_overlay.js"></script>
    <style>
        html {
            background: #FFFFFF;
            height: 100%;
        }

        body {
            margin: 0;
            height: 100%;
        }

        #chart {
            height: 100%;
        }
    </style>
</head>
<body>
<div id="chart"></div>
<script>
  var chart = klinecharts.init('chart', {
    timezone: 'Asia/Shanghai',
    customApi: {
      formatDate: function (dateTimeFormat, timestamp, format, type) {
        return timestamp
      }
    }
  })
  chart._chartStore._timeScaleStore.setBarSpaceLimitConfig(0.01, 20)
  // chart.createIndicator('MA', false, { id: 'candle_pane' })
  chart.createIndicator('VOL')
  chart.createIndicator('MACD')
  chart.setStyles({
    // 网格线
    grid: {
      show: true,
      horizontal: {
        show: true,
        size: 1,
        color: '#E6E6E6',
        style: 'solid',
      },
      vertical: {
        show: false,
        size: 0,
        color: '#E6E6E6',
        style: 'solid',
      }
    },
    candle: {
      // 蜡烛图类型 'candle_solid'|'candle_stroke'|'candle_up_stroke'|'candle_down_stroke'|'ohlc'|'area'
      type: 'candle_solid',
      bar: {
        upColor: '#F21414',
        downColor: '#08B536',
        noChangeColor: '#888888',
        upBorderColor: '#F21414',
        downBorderColor: '#08B536',
        noChangeBorderColor: '#888888',
        upWickColor: '#F21414',
        downWickColor: '#08B536',
        noChangeWickColor: '#888888'
      },
    },
    indicator: {
      bars: [{
        // 'fill' | 'stroke' | 'stroke_fill'
        style: 'fill',
        // 'solid' | 'dashed'
        borderStyle: 'solid',
        borderSize: 1,
        borderDashedValue: [2, 2],
        upColor: '#F21414',
        downColor: '#08B536',
        noChangeColor: '#888888'
      }],
      lastValueMark: {
        show: true,
      },
    }
  });

  var chan_id = '';

  chart._chartStore.getTimeScaleStore().zoom(1000)
  fetch(`/data`).then(response => response.json())
    .then(data => {
      chartDataList = data.bar_list
      chart.applyNewData(chartDataList)

      chan_id = data.chan_id

      data.bar_union_list?.forEach(item => chart.createOverlay(barUnionOverlayData(item)))
      data.fractal_list?.forEach(item => chart.createOverlay(fractalOverlayData(item)))
      data.stroke_list?.forEach(item => chart.createOverlay(strokeOverlayData(item)))
      data.stroke_list?.forEach(item => chart.createOverlay(strokeBarOverlayData(item)))
      data.segment_list?.forEach(item => chart.createOverlay(segmentOverlayData(item)))

      setInterval(intervalUpdate, 1000);
    });
  function intervalUpdate() {
    fetch(`/update/${chan_id}`).then(response => response.json())
      .then(data => {
        chartDataList = data.bar_list
        for (const dataKey in chartDataList) {
          chart.updateData(chartDataList[dataKey])
        }

        data.bar_union_list?.forEach(function (item) {
          item = barUnionOverlayData(item)
          if (chart.getOverlayById(item.id) == null) {
            chart.createOverlay(item)
          } else {
            chart.overrideOverlay(item)
          }
        })
        data.fractal_list?.forEach(function (item) {
          item = fractalOverlayData(item)
          if (chart.getOverlayById(item.id) == null) {
            chart.createOverlay(item)
          } else {
            chart.overrideOverlay(item)
          }
        })
        data.stroke_list?.forEach(function (item) {
          item = strokeOverlayData(item)
          if (chart.getOverlayById(item.id) == null) {
            chart.createOverlay(item)
          } else {
            chart.overrideOverlay(item)
          }
        })
        data.stroke_list?.forEach(function (item) {
          item = strokeBarOverlayData(item)
          if (chart.getOverlayById(item.id) == null) {
            chart.createOverlay(item)
          } else {
            chart.overrideOverlay(item)
          }
        })
        data.segment_list?.forEach(function (item) {
          item = segmentOverlayData(item)
          if (chart.getOverlayById(item.id) == null) {
            chart.createOverlay(item)
          } else {
            chart.overrideOverlay(item)
          }
        })
      })
  }
</script>
</body>
</html>